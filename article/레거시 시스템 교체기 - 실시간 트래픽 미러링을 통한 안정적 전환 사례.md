# [레거시 시스템 교체기: 실시간 트래픽 미러링을 통한 안정적 전환 사례](https://medium.com/naverfinancial/%EB%A0%88%EA%B1%B0%EC%8B%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B5%90%EC%B2%B4%EA%B8%B0-%EC%8B%A4%EC%8B%9C%EA%B0%84-%ED%8A%B8%EB%9E%98%ED%94%BD-%EB%AF%B8%EB%9F%AC%EB%A7%81%EC%9D%84-%ED%86%B5%ED%95%9C-%EC%95%88%EC%A0%95%EC%A0%81-%EC%A0%84%ED%99%98-%EC%82%AC%EB%A1%80-99222c7362d7)

- 기존 API를 신규 API로 대체
  - WebFlux의 러닝 커브와 코드의 일관성을 유지하기 힘들어, 직관적이고 익숙한 WebMVC로 변경.
  - 기존 API 스펙과 응답을 신규 API에서 100% 동일하게 유지하는 것을 목표로 함.
  - 요청별 응답을 자동으로 비교하는 미들웨어 도입.
  - 신규 시스템과 기존 시스템을 한동안 동시 운영하며 검증.
  - 사용자에게는 여전히 기존 시스템이 응답을 주는 상태를 유지, 백엔드 내부에서는 신규 시스템 응답을 비교.
- 고려한 방법
  - Application Layer 복제
    - 코드 내부에서 트래픽을 이중 처리
    - 운영 중인 애플리케이션의 안정성에 영향을 줄 수 있음
  - 메시지 큐 기반 테스트 환경 구성
    - 실시간 트래픽을 Kafka 등 외부 큐에 저장하고, 별도의 테스트 환경에서 리플레이 검증
    - 테스트 결과의 정확도는 높지만, 큐 시스템 구축과 메시지 처리 등의 환경을 구축하는데 비용이 큼.
  - 트래픽 미러링
    - 프론트 프록시(Nginx 등)에서 클라이언트 요청을 실시간으로 복제하여 기존 시스템과 신규 시스템에 동시에 전달
    - 손쉽게 도입 가능, 실시간 비교 가능
    - 신규 시스템에 대한 로그 수집 시스템을 별도로 구축해야 함.
- 구현 난이도, 환경 등을 고려해 nginx 트래픽 미러링을 사용.
  - 프로덕션의 실제 트래픽을 복제하여 새로운 시스템에서 동시에 처리
  - 사용자에게 영향을 주지 않고도 새로운 버전의 시스템이 실제 트래픽에서 제대로 동작하는지 검증
  - 하나의 요청이 기존 시스템과 신규 시스템, 2개로 전파되며, 응답은 기존 시스템 것만 사용.
  - 신규 시스템에 대한 로그나 모니터링 시스템 구축.
  - 신규 시스템에 대한 요청은 응답을 기다리지 않도록 타임아웃을 극도로 작게 설정. (1ms)
- WebMVC로 변경하면서, 코드가 줄어들고 유지보수성(인지 복잡도로 측정)이 좋아짐.

---
### Comment
- 신규 API 교체를 여러번 하면서 느낀 경험은, 애플리케이션 레이어에서 처리하는게 제일 쉽다.
  - 기존 시스템이 응답 값을 만들면, 비동기로 신규 시스템을 호출하고 응답 return.
  - 신규 시스템에서 기존 시스템 응답을 받아와 결과를 판별. 같지 않다면 알림을 보내 상세 내용을 파악하도록 할 수 있다.
  - 신규 시스템 호출을 위한 스레드를 생성하는데, 성능에 영향을 줄 정도가 아니라면(보통 영향 거의 없음.) 가장 손쉬운 방법 같다.
- 궁금했던 건, 개발 과정에서 신규 API와 기존 API의 응답이 동일함을 보장하는 '테스트 자동화'는 어떻게 구축했을까?
  - CI에 테스트 자동화가 구축되었을까?
  - 2개의 프로세스(기존/신규)와 외부 컴포넌트(mock api를 사용한다고 하더라도)를 테스트를 구축하는 것이 쉽지 않음. 프로세스 외부의 의존성이 생기면 테스트 자체가 비결정적으로 깨지기도 함. (모종의 이유로 가끔씩 실패하는 경우가 발생함.)