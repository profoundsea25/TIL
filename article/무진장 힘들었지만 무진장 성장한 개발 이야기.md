# [무진장 힘들었지만 무진장 성장한 개발 이야기](https://medium.com/musinsa-tech/%EB%AC%B4%EC%A7%84%EC%9E%A5-%ED%9E%98%EB%93%A4%EC%97%88%EC%A7%80%EB%A7%8C-%EB%AC%B4%EC%A7%84%EC%9E%A5-%EC%84%B1%EC%9E%A5%ED%95%9C-%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0-e445888579a9)

- 여름/겨울 무진장 세일 동안 시스템 안정성을 시험받는다.
- 무신사 철학: 고객과 입점 브랜드 모두에게 최고의 경험을 선사해야 한다.
- 2025 여름 목표 (피크 타임 기준)
   - 분당 매출 1억 원
   - 분당 주문 1만 건을 안정적으로 처리
   - 이벤트 분당 약 400만건의 요청 (초당 6만 7천건)

#### 1–1. 읽기(Read)와 쓰기(Write)의 분리, CQRS 아키텍처 도입
- 전시 시스템과 주문 시스템의 의존성을 분리.
   - 쓰기는 AWS Aurora, 읽기는 Redis 사용
   - 이벤트에 필요한 모든 상품 데이터를 사전에 가공하여 Materialized View 형태로 Redis에 저장
- 최종적 일관성을 구현하기 위해, CDC 파이프라인 구축
   - 이벤트 스트리밍 기술(AWS DMS, Kafka) 등을 활용해 데이터베이스의 쓰기 변경 로그를 실시간으로 감지하여 조회용 Redis에 반영
   - 이로 인해 DB의 변경 사항이 Redis에 반영되기 까지의 시차가 존재
   - 서비스가 마비되는 것보다 몇 초 동안 잠시 일관성이 깨지는 것이 더 낫기 때문.

#### 1–2. 1바이트의 전쟁: Redis 데이터 압축 최적화
- 네트워크 대역폭과 Redis 메모리 사용량이 커지는 것을 방지하기 위해 데이터를 압축해서 저장.
- 압축/해제 시간과 CPU 사용량을 고려해 선택. 직접 벤치마킹 수행.
   - LZ4가 다른 알고리즘에 비해 압축률은 크게 높진 않지만, 압도적으로 빠른 압축 해제 속도와 낮은 CPU 점유율을 보임.
- 조건부 압축
   - 1kb 미만은 압축하지 않음. 압축/해제에 드는 CPU 비용이 네트워크 절감 효과보다 크기 때문.
- 이로써 레디스 사용량 70% 감소.

#### 1–3. 예측 가능한 미래, 캐시로 준비하기: 타임세일 캐시 전략
- 콜드 스타트(Cold Start)
   - 캐시가 준비되지 않은 상태에서 요청을 처리해야 하는 문제
   - 특정 시간에 트래픽이 몰릴 것이 명백하다면 콜드 스타드 문제를 해결해야 한다.
      - 캐시 미스로 인해 원본 DB에 트래픽이 한번에 몰릴 수 있다.(캐시 스탬피드(Cache Stampede))
- 캐시 워밍(Cache Warming) = 캐시 프리페칭(Cache Prefetching)
   - 미리 데이터를 캐싱해놓음.

#### 2–1. 주문 시스템의 진화: 이벤트 기반 아키텍처로의 전환
- Kafka를 메시징 플랫폼으로 도입하여 이벤트 기반 아키텍처로 시스템 전면 재설계
- 가장 큰 장점은 분리와 탄력성. 어느 시스템 하나가 느려지더라도 다른 시스템은 영향 받지 않는다.
- 데이터 정합성 유지를 위해 사가 패턴을 적용 (*코레오그라피 아닌가?*)
   - 각 서비스에서 로컬 트랜잭션을 처리하고, 성공하면 다음 이벤트 발행, 실패하면 보상 이벤트를 발행.

#### 2–2. 0.1초의 승부: 실시간 재고 시스템의 안정성 및 확장성 강화
- 1차: Redis를 활용한 비관적 재고 검사
- 2차: Redis 분산 락(Redlock)을 사용한 임계 영역 보호
  - 재고 UPDATE 로직을 임계 영역으로 감쌈.
- 3차: DB 낙관적 락
  - 재고 컬럼에 version을 추가하여 낙관적 락 사용

#### 2–3. 600줄 쿼리와의 이별: 대용량 트래픽을 위한 쿠폰 시스템 개선
- 실시간 계산에서 사전 계산으로 전환
  - 요청 시점에 복잡한 계산을 수행하는 대신, 데이터가 변경되는 시점에 미리 계산 결과를 저장.
  - 요청 시점에 단순 조회만 하도록 변경.

#### 3–1. 장애 예측 시스템: AIOps를 활용한 선제적 이상 징후 탐지
- 기존의 모니터링은 사후 대응에 가깝다. 임계치를 넘으면 알림 받는 형식.
- 선제적 대응을 위해 AIOps 도입
  - 마이크로서비스에서 나오는 로그, 메트릭, 트레이스를 수집하고 분석
  - 이상 징후를 탐지하고, 이벤트 상관관계 분석

#### 3–2. 비상 스위치를 손에 쥐다: Feature Flag를 활용한 유연한 기능 제어
- 피처 토글 사용.
  - 신규 기능을 배포 없이 on/off
  - 점진적으로 신기능을 트래픽에 노출시킨다. (1~100% 조절)
  - 타겟 마케팅을 위해 특정 사용자만 새롤운 기능을 제공한다.

---

### Comment
- 최근 기술 블로그의 성능 향상에는 레디스가 빠지지 않는 것 같다.